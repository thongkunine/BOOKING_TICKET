<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Badminton Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #343a40;
            color: white;
            width: 250px;
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: #f8f9fa;
            padding: 10px 20px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link.active {
            background-color: #4a90e2;
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .navbar {
            background-color: #343a40;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background-color: #4a90e2;
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table thead {
            background-color: #f8f9fa;
        }
        .btn-primary {
            background-color: #4a90e2;
            border: none;
        }
        .btn-primary:hover {
            background-color: #357abd;
        }
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .alert {
            border-radius: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .loading i {
            font-size: 24px;
            color: #4a90e2;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .user-info {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }
        .user-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .user-info .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .user-info .user-role {
            font-size: 0.8rem;
            color: #adb5bd;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .modal-dialog {
            max-width: 500px;
        }
        .seat {
            background-color: #ccc;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .seat.available {
            background-color: #28a745;
        }
        .seat.reserved {
            background-color: #ffc107;
        }
        .seat.sold {
            background-color: #dc3545;
        }
        .form-text {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .seat-preview {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-sticky">
            <div class="user-info d-flex align-items-center">
                <img src="http://localhost:5000/avatars/1744210355640-anhcv.jpg" alt="User Avatar" id="userAvatar">
                <div>
                    <div class="user-name" id="userName">Admin</div>
                    <div class="user-role" id="role.name">Administrator</div>
                </div>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="users">
                        <i class="fas fa-users"></i> Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="events">
                        <i class="fas fa-calendar-alt"></i> Events
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="seats">
                        <i class="fas fa-chair"></i> Seats
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="tickets">
                        <i class="fas fa-ticket-alt"></i> Tickets
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="orders">
                        <i class="fas fa-shopping-cart"></i> Orders
                    </a>
                </li>
                <li class="nav-item mt-5">
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main content -->
    <main class="main-content">
        <div class="container-fluid">           
            <!-- Alert messages -->
            <div class="alert alert-success" id="successAlert" role="alert" style="display: none;"></div>
            <div class="alert alert-danger" id="errorAlert" role="alert" style="display: none;"></div>
            
            <!-- Loading indicator -->
            <div class="loading" id="loading">
                <i class="fas fa-spinner"></i> Loading...
            </div>

            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboardSection">
                <h2 class="mb-4">Dashboard</h2>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Total Users</h5>
                                <p class="card-text display-4" id="userCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Total Events</h5>
                                <p class="card-text display-4" id="eventCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Total Tickets</h5>
                                <p class="card-text display-4" id="ticketCount">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Total Orders</h5>
                                <p class="card-text display-4" id="orderCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="content-section" id="usersSection">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>User Management</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role </th>
                                        <th>Actions</th>
                                    </tr>   
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Events Section -->
            <div class="content-section" id="eventsSection">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Event Management</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
                        <i class="fas fa-plus"></i> Add Event
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Date</th>
                                        <th>Location</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="eventsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seats Section -->
            <div class="content-section" id="seatsSection">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Seat Management</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSeatModal">
                        <i class="fas fa-plus"></i> Add Seat
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Seat Number</th>
                                        <th>Event</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="seatsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tickets Section -->
            <div class="content-section" id="ticketsSection">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Ticket Management</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTicketModal">
                        <i class="fas fa-plus"></i> Add Ticket
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Event</th>
                                        <th>Type</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ticketsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div class="content-section" id="ordersSection">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Order Management</h2>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Event</th>
                                        <th>Ticket ID</th>
                                        <th>Total Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>    
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-control" name="role" required>
                                <option value="User">User</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addEventForm">
                        <div class="mb-3">
                            <label class="form-label">Event Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" name="location" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEventBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Seat Modal -->
    <div class="modal fade" id="addSeatModal" tabindex="-1" aria-labelledby="addSeatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSeatModalLabel">Add New Seat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addSeatForm">
                        <div class="mb-3">
                            <label for="event_id" class="form-label">Event</label>
                            <select class="form-control" id="event_id" name="event_id" required>
                                <option value="">Select Event</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="seat_number" class="form-label">Seat Number</label>
                            <input type="text" class="form-control" id="seat_number" name="seat_number" required>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-control" id="status" name="status" required>
                                <option value="available">Available</option>
                                <option value="reserved">Reserved</option>
                                <option value="sold">Sold</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSeatBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Ticket Modal -->
    <div class="modal fade" id="addTicketModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTicketForm">
                        <div class="mb-3">
                            <label class="form-label">Event</label>
                            <select class="form-control" name="event_id" required>
                                <option value="">Select an event</option>
                                <!-- Events will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <input type="text" class="form-control" name="type" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" name="price" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTicketBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" name="user_id" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" id="editUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-control" name="role" id="editRole" required>
                                <option value="User">User</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateUserBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Edit Event Modal -->
    <div class="modal fade" id="editEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEventForm">
                        <input type="hidden" name="event_id" id="editEventId">
                        <div class="mb-3">
                            <label class="form-label">Event Name</label>
                            <input type="text" class="form-control" name="name" id="editEventName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date" id="editEventDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" name="location" id="editEventLocation" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" id="editEventDescription" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateEventBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Edit Seat Modal -->
    <div class="modal fade" id="editSeatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Seat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSeatForm">
                        <input type="hidden" name="seat_id" id="editSeatId">
                        <div class="mb-3">
                            <label class="form-label">Event</label>
                            <select class="form-control" name="event_id" id="editSeatEventId" required>
                                <option value="">Select an event</option>
                                <!-- Events will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Seat Number</label>
                            <input type="text" class="form-control" name="seat_number" id="editSeatNumber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" id="editSeatStatus" required>
                                <option value="available">Available</option>
                                <option value="reserved">Reserved</option>
                                <option value="sold">Sold</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateSeatBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Edit Ticket Modal -->
    <div class="modal fade" id="editTicketModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTicketForm">
                        <input type="hidden" name="ticket_id" id="editTicketId">
                        <div class="mb-3">
                            <label class="form-label">Event</label>
                            <select class="form-control" name="event_id" id="editTicketEventId" required>
                                <option value="">Select an event</option>
                                <!-- Events will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <input type="text" class="form-control" name="type" id="editTicketType" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" name="price" id="editTicketPrice" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" id="editTicketQuantity" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateTicketBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <input type="hidden" id="editOrderId">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editOrderStatus" required>
                                <option value="pending">Pending</option>
                                <option value="paid">Paid</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" id="editOrderPaymentMethod" required>
                                <option value="cash">Cash</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="momo">Momo</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateOrderBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // API base URL - update this to match your server's URL
            const API_BASE_URL = 'http://localhost:4000'; // Updated to use port 4000
            
            // Check authentication
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '../login/login_signup/login.html';
                return;
            }

            // Load user info
            loadUserInfo();
            
            // Load initial data
            loadDashboardData();

            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.id === 'logoutBtn') {
                        e.preventDefault();
                        handleLogout();
                        return;
                    }
                    
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    if (section) {
                        // Update active nav link
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Show corresponding section
                        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                        document.getElementById(`${section}Section`).classList.add('active');
                        
                        // Update page title - Check if element exists first
                        const pageTitleElement = document.getElementById('pageTitle');
                        if (pageTitleElement) {
                            pageTitleElement.textContent = this.textContent.trim();
                        } else {
                            console.warn("Element with id 'pageTitle' not found");
                        }
                        
                        // Load section data
                        switch(section) {
                            case 'users':
                                loadUsers();
                                break;
                            case 'events':
                                loadEvents();
                                break;
                            case 'seats':
                                loadSeats();
                                break;
                            case 'tickets':
                                loadTickets();
                                // Load events for ticket form when switching to tickets tab
                                loadEventsForTicketForm();
                                break;
                            case 'orders':
                                loadOrders();
                                break;
                        }
                    }
                });
            });

            // Functions for user management
            async function loadUserInfo() {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        const userNameElement = document.getElementById('userName');
                        const userRoleElement = document.getElementById('userRole');
                        const userAvatarElement = document.getElementById('userAvatar');

                        if (userNameElement) {
                            userNameElement.textContent = data.data.username;
                        }
                        
                        if (userRoleElement) {
                            userRoleElement.textContent = data.data.role;
                        }
                        
                        if (userAvatarElement && data.data.avatarUrl) {
                            userAvatarElement.src = data.data.avatarUrl;
                        }
                    }
                } catch (error) {
                    console.error('Error loading user info:', error);
                    showError('Failed to load user info');
                }
            }

            async function loadUsers() {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/users`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        const usersTableBody = document.getElementById('usersTableBody');
                        usersTableBody.innerHTML = '';
                        
                        data.data.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user._id}</td>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${user.role.name}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-user" data-id="${user._id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-user" data-id="${user._id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            usersTableBody.appendChild(row);
                        });

                        // Add event listeners
                        addUserEventListeners();
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                    showError('Failed to load users');
                }
                
                loading.style.display = 'none';
            }

            // Functions for event management
            async function loadEvents() {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/events`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        const eventsTableBody = document.getElementById('eventsTableBody');
                        eventsTableBody.innerHTML = '';
                        
                        data.data.forEach(event => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${event._id}</td>
                                <td>${event.name}</td>
                                <td>${new Date(event.date).toLocaleDateString()}</td>
                                <td>${event.location}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-event" data-id="${event._id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-event" data-id="${event._id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            eventsTableBody.appendChild(row);
                        });

                        // Add event listeners
                        addEventEventListeners();
                    }
                } catch (error) {
                    console.error('Error loading events:', error);
                    showError('Failed to load events');
                }
                
                loading.style.display = 'none';
            }

            // Functions for seat management
            async function loadSeats() {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                
                try {
                    console.log('Fetching seats from API...');
                    const response = await fetch(`${API_BASE_URL}/seats`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    console.log('Seats API response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Seats data:', data);
                    
                    const seatsTableBody = document.getElementById('seatsTableBody');
                    if (!seatsTableBody) {
                        console.error('Seats table body element not found!');
                        showError('Error: Seats table element not found');
                        return;
                    }
                    
                    seatsTableBody.innerHTML = '';
                    
                    if (data && data.length > 0) {
                        data.forEach(seat => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${seat._id}</td>
                                <td>${seat.seat_number}</td>
                                <td>${seat.event_id ? seat.event_id.name : 'N/A'}</td>
                                <td>
                                    <span class="badge ${getStatusBadgeClass(seat.status)}">
                                        ${seat.status}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-seat" data-id="${seat._id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-seat" data-id="${seat._id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            seatsTableBody.appendChild(row);
                        });
                    } else {
                        seatsTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center">No seats found</td>
                            </tr>
                        `;
                    }

                    // Add event listeners for seat actions
                    addSeatEventListeners();
                } catch (error) {
                    console.error('Error loading seats:', error);
                    showError('Failed to load seats: ' + error.message);
                    const seatsTableBody = document.getElementById('seatsTableBody');
                    if (seatsTableBody) {
                        seatsTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center text-danger">Error loading seats: ${error.message}</td>
                            </tr>
                        `;
                    }
                } finally {
                    loading.style.display = 'none';
                }
            }

            // Add event listener to load events when the add seat modal is opened
            document.getElementById('addSeatModal').addEventListener('show.bs.modal', function() {
                loadEventsForSeatForm();
            });

            // Load events for seat form
            async function loadEventsForSeatForm() {
                try {
                    console.log('Loading events for seat form...');
                    const response = await fetch(`${API_BASE_URL}/events`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Events data:', data);
                    
                    if (data.success) {
                        const options = data.data.map(event => 
                            `<option value="${event._id}">${event.name} - ${new Date(event.date).toLocaleDateString()}</option>`
                        ).join('');
                        
                        // Update both add and edit forms
                        const addEventSelect = document.getElementById('event_id');
                        const editEventSelect = document.getElementById('editSeatEventId');
                        
                        if (addEventSelect) {
                            addEventSelect.innerHTML = '<option value="">Select an event</option>' + options;
                            console.log('Updated add seat event select:', addEventSelect.innerHTML);
                        }
                        
                        if (editEventSelect) {
                            editEventSelect.innerHTML = '<option value="">Select an event</option>' + options;
                        }
                    }
                } catch (error) {
                    console.error('Error loading events for seat form:', error);
                    showError('Failed to load events for seat form');
                }
            }

            // Save seat button click handler
            const saveSeatBtn = document.getElementById('saveSeatBtn');
            if (saveSeatBtn) {
                saveSeatBtn.addEventListener('click', async function() {
                    const form = document.getElementById('addSeatForm');
                    if (!form) {
                        console.error('Form not found');
                        return;
                    }
                    
                    // Get form values
                    const eventId = document.getElementById('event_id').value;
                    const seatNumber = document.getElementById('seat_number').value;
                    const status = document.getElementById('status').value;
                    
                    console.log('Form values:', { eventId, seatNumber, status });
                    
                    // Validate form data
                    if (!eventId || !seatNumber || !status) {
                        showError('Please fill in all required fields');
                        return;
                    }
                    
                    try {
                        const seatData = {
                            event_id: eventId,
                            seat_number: seatNumber,
                            status: status
                        };
                        
                        console.log('Sending seat data:', seatData);
                        
                        const response = await fetch(`${API_BASE_URL}/seats`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(seatData)
                        });
                        
                        const responseData = await response.json();
                        console.log('Server response:', responseData);
                        
                        if (response.ok) {
                            showSuccess('Seat added successfully');
                            // Close modal using Bootstrap 5 API
                            const modal = bootstrap.Modal.getInstance(document.getElementById('addSeatModal'));
                            if (modal) {
                                modal.hide();
                            }
                            form.reset();
                            loadSeats();
                        } else {
                            throw new Error(responseData.message || 'Failed to add seat');
                        }
                    } catch (error) {
                        console.error('Error adding seat:', error);
                        showError(error.message || 'Failed to add seat');
                    }
                });
            }

            // Add event listeners for seat management
            function addSeatEventListeners() {
                // Edit seat
                document.querySelectorAll('.edit-seat').forEach(button => {
                    button.addEventListener('click', async function() {
                        const seatId = this.getAttribute('data-id');
                        try {
                            const response = await fetch(`${API_BASE_URL}/seats/${seatId}`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            if (data.success) {
                                const seat = data.data;
                                document.getElementById('editSeatId').value = seat._id;
                                document.getElementById('editSeatNumber').value = seat.seat_number;
                                document.getElementById('editSeatStatus').value = seat.status;
                                
                                // Load events for the select dropdown
                                await loadEventsForSeatForm();
                                document.getElementById('editSeatEventId').value = seat.event_id._id;
                                
                                // Show the edit modal
                                const editModal = new bootstrap.Modal(document.getElementById('editSeatModal'));
                                editModal.show();
                            }
                        } catch (error) {
                            console.error('Error loading seat data:', error);
                            showError('Failed to load seat data');
                        }
                    });
                });

                // Delete seat
                document.querySelectorAll('.delete-seat').forEach(button => {
                    button.addEventListener('click', async function() {
                        const seatId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this seat? This action cannot be undone.')) {
                            try {
                                const response = await fetch(`${API_BASE_URL}/seats/${seatId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                
                                if (response.ok) {
                                    showSuccess('Seat deleted successfully');
                                    loadSeats();
                                    loadDashboardData();
                                } else {
                                    const errorData = await response.json();
                                    throw new Error(errorData.message || 'Failed to delete seat');
                                }
                            } catch (error) {
                                console.error('Error deleting seat:', error);
                                showError(error.message || 'Failed to delete seat');
                            }
                        }
                    });
                });
            }

            // Add update seat button click handler
            document.getElementById('updateSeatBtn').addEventListener('click', async function() {
                const form = document.getElementById('editSeatForm');
                const seatId = document.getElementById('editSeatId').value;
                const formData = new FormData(form);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/seats/${seatId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            event_id: formData.get('event_id'),
                            seat_number: formData.get('seat_number'),
                            status: formData.get('status')
                        })
                    });
                    
                    if (response.ok) {
                        showSuccess('Seat updated successfully');
                        // Close modal using Bootstrap API
                        const editModal = bootstrap.Modal.getInstance(document.getElementById('editSeatModal'));
                        if (editModal) {
                            editModal.hide();
                        }
                        loadSeats();
                        loadDashboardData();
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to update seat');
                    }
                } catch (error) {
                    console.error('Error updating seat:', error);
                    showError(error.message || 'Failed to update seat');
                }
            });

            // Helper function to get badge class based on status
            function getStatusBadgeClass(status) {
                switch(status?.toLowerCase()) {
                    case 'available':
                        return 'bg-success';
                    case 'reserved':
                        return 'bg-warning';
                    case 'sold':
                        return 'bg-danger';
                    default:
                        return 'bg-secondary';
                }
            }

            async function handleLogout() {
                try {
                    await fetch(`${API_BASE_URL}/auth/logout`);
                    localStorage.removeItem('token');
                    window.location.reload();
                    window.location.href = '../../login/login_signup/login.html';
                } catch (error) {
                    console.error('Error during logout:', error);
                    localStorage.removeItem('token');
                    window.location.reload();
                    window.location.href = '../../login/login_signup/login.html';
                }
            }

            // Utility functions
            function showSuccess(message) {
                const alert = document.getElementById('successAlert');
                alert.textContent = message;
                alert.style.display = 'block';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }

            function showError(message) {
                const alert = document.getElementById('errorAlert');
                alert.textContent = message;
                alert.style.display = 'block';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }

            // Load initial dashboard data
            async function loadDashboardData() {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                
                // Debug token
                console.log("Current token:", token);
                
                try {
                    // Load users count
                    try {
                        console.log("Fetching users data...");
                        const usersResponse = await fetch(`${API_BASE_URL}/users`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        console.log("Users response status:", usersResponse.status);
                        
                        if (!usersResponse.ok) {
                            if (usersResponse.status === 403) {
                                console.error('Access denied: You need admin permissions to view users');
                                document.getElementById('userCount').textContent = 'Access Denied';
                                showError('Access denied: You need admin permissions to view users');
                                return;
                            }
                            throw new Error(`HTTP error! status: ${usersResponse.status}`);
                        }
                        
                        const usersData = await usersResponse.json();
                        console.log("Users data:", usersData);
                        
                        if (usersData.success) {
                            document.getElementById('userCount').textContent = usersData.data.length;
                        }
                    } catch (error) {
                        console.error('Error loading users:', error);
                        document.getElementById('userCount').textContent = 'Error';
                    }

                    // Load events count
                    try {
                        const eventsResponse = await fetch(`${API_BASE_URL}/events`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (!eventsResponse.ok) {
                            throw new Error(`HTTP error! status: ${eventsResponse.status}`);
                        }
                        const eventsData = await eventsResponse.json();
                        if (eventsData.success) {
                            document.getElementById('eventCount').textContent = eventsData.data.length;
                        }
                    } catch (error) {
                        console.error('Error loading events:', error);
                        document.getElementById('eventCount').textContent = 'Error';
                    }

                    // Load tickets count
                    try {
                        const ticketsResponse = await fetch(`${API_BASE_URL}/tickets`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (!ticketsResponse.ok) {
                            throw new Error(`HTTP error! status: ${ticketsResponse.status}`);
                        }
                        const ticketsData = await ticketsResponse.json();
                        if (ticketsData.success) {
                            document.getElementById('ticketCount').textContent = ticketsData.data.length;
                        }
                    } catch (error) {
                        console.error('Error loading tickets:', error);
                        document.getElementById('ticketCount').textContent = 'Error';
                    }

                    // Load orders count - Only if the route exists
                    try {
                        const ordersResponse = await fetch(`${API_BASE_URL}/orders`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (!ordersResponse.ok) {
                            if (ordersResponse.status === 404) {
                                // Route doesn't exist yet, show 0
                                document.getElementById('orderCount').textContent = '0';
                                return;
                            }
                            throw new Error(`HTTP error! status: ${ordersResponse.status}`);
                        }
                        const ordersData = await ordersResponse.json();
                        if (ordersData.success) {
                            document.getElementById('orderCount').textContent = ordersData.data.length;
                        }
                    } catch (error) {
                        console.error('Error loading orders:', error);
                        document.getElementById('orderCount').textContent = 'Error';
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    showError('Failed to load dashboard data');
                } finally {
                    loading.style.display = 'none';
                }
            }

            // Add event listeners for user management
            function addUserEventListeners() {
                // Edit user
                document.querySelectorAll('.edit-user').forEach(button => {
                    button.addEventListener('click', async function() {
                        const userId = this.getAttribute('data-id');
                        try {
                            const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            if (data.success) {
                                const user = data.data;
                                document.getElementById('editUserId').value = user._id;
                                document.getElementById('editUsername').value = user.username;
                                document.getElementById('editEmail').value = user.email;
                                document.getElementById('editRole').value = user.role.name;
                                
                                // Show the edit modal
                                const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                                editModal.show();
                            }
                        } catch (error) {
                            console.error('Error loading user data:', error);
                            showError('Failed to load user data');
                        }
                    });
                });

                // Delete user
                document.querySelectorAll('.delete-user').forEach(button => {
                    button.addEventListener('click', async function() {
                        const userId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                            try {
                                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                
                                if (response.ok) {
                                    showSuccess('User deleted successfully');
                                    loadUsers();
                                    loadDashboardData();
                                } else {
                                    const errorData = await response.json();
                                    throw new Error(errorData.message || 'Failed to delete user');
                                }
                            } catch (error) {
                                console.error('Error deleting user:', error);
                                showError(error.message || 'Failed to delete user');
                            }
                        }
                    });
                });
            }

            // Add update user button click handler
            document.getElementById('updateUserBtn').addEventListener('click', async function() {
                const form = document.getElementById('editUserForm');
                const userId = document.getElementById('editUserId').value;
                const formData = new FormData(form);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            username: formData.get('username'),
                            email: formData.get('email'),
                            role: formData.get('role')
                        })
                    });
                    
                    if (response.ok) {
                        showSuccess('User updated successfully');
                        $('#editUserModal').modal('hide');
                        loadUsers();
                        loadDashboardData();
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to update user');
                    }
                } catch (error) {
                    console.error('Error updating user:', error);
                    showError(error.message || 'Failed to update user');
                }
            });

            // Add event listeners for event management
            function addEventEventListeners() {
                // Edit event
                document.querySelectorAll('.edit-event').forEach(button => {
                    button.addEventListener('click', async function() {
                        const eventId = this.getAttribute('data-id');
                        try {
                            const response = await fetch(`${API_BASE_URL}/events/${eventId}`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            if (data.success) {
                                const event = data.data;
                                document.getElementById('editEventId').value = event._id;
                                document.getElementById('editEventName').value = event.name;
                                document.getElementById('editEventDate').value = new Date(event.date).toISOString().split('T')[0];
                                document.getElementById('editEventLocation').value = event.location;
                                document.getElementById('editEventDescription').value = event.description;
                                
                                // Show the edit modal
                                const editModal = new bootstrap.Modal(document.getElementById('editEventModal'));
                                editModal.show();
                            }
                        } catch (error) {
                            console.error('Error loading event data:', error);
                            showError('Failed to load event data');
                        }
                    });
                });

                // Delete event
                document.querySelectorAll('.delete-event').forEach(button => {
                    button.addEventListener('click', async function() {
                        const eventId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                            try {
                                const response = await fetch(`${API_BASE_URL}/events/${eventId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                
                                if (response.ok) {
                                    showSuccess('Event deleted successfully');
                                    loadEvents();
                                    loadDashboardData();
                                } else {
                                    const errorData = await response.json();
                                    throw new Error(errorData.message || 'Failed to delete event');
                                }
                            } catch (error) {
                                console.error('Error deleting event:', error);
                                showError('Failed to delete event');
                            }
                        }
                    });
                });
            }

            // Add update event button click handler
            document.getElementById('updateEventBtn').addEventListener('click', async function() {
                const form = document.getElementById('editEventForm');
                const eventId = document.getElementById('editEventId').value;
                const formData = new FormData(form);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/events/${eventId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            name: formData.get('name'),
                            date: formData.get('date'),
                            location: formData.get('location'),
                            description: formData.get('description')
                        })
                    });
                    
                    if (response.ok) {
                        showSuccess('Event updated successfully');
                        // Close modal using Bootstrap API
                        const editModal = bootstrap.Modal.getInstance(document.getElementById('editEventModal'));
                        if (editModal) {
                            editModal.hide();
                        }
                        loadEvents();
                        loadDashboardData();
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to update event');
                    }
                } catch (error) {
                    console.error('Error updating event:', error);
                    showError(error.message || 'Failed to update event');
                }
            });

            // Add event listeners for ticket management
            function addTicketEventListeners() {
                // Edit ticket
                document.querySelectorAll('.edit-ticket').forEach(button => {
                    button.addEventListener('click', async function() {
                        const ticketId = this.getAttribute('data-id');
                        try {
                            const response = await fetch(`${API_BASE_URL}/tickets/${ticketId}`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            if (data.success) {
                                const ticket = data.data;
                                document.getElementById('editTicketId').value = ticket._id;
                                document.getElementById('editTicketType').value = ticket.type;
                                document.getElementById('editTicketPrice').value = ticket.price;
                                document.getElementById('editTicketQuantity').value = ticket.quantity;
                                
                                // Load events for the select dropdown
                                await loadEventsForTicketForm();
                                document.getElementById('editTicketEventId').value = ticket.event_id._id;
                                
                                // Show the edit modal
                                const editModal = new bootstrap.Modal(document.getElementById('editTicketModal'));
                                editModal.show();
                            }
                        } catch (error) {
                            console.error('Error loading ticket data:', error);
                            showError('Failed to load ticket data');
                        }
                    });
                });

                // Delete ticket
                document.querySelectorAll('.delete-ticket').forEach(button => {
                    button.addEventListener('click', async function() {
                        const ticketId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
                            try {
                                const response = await fetch(`${API_BASE_URL}/tickets/${ticketId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                
                                if (response.ok) {
                                    showSuccess('Ticket deleted successfully');
                                    loadTickets();
                                    loadDashboardData();
                                } else {
                                    const errorData = await response.json();
                                    throw new Error(errorData.message || 'Failed to delete ticket');
                                }
                            } catch (error) {
                                console.error('Error deleting ticket:', error);
                                showError(error.message || 'Failed to delete ticket');
                            }
                        }
                    });
                });
            }

            // Add event listener to load events when the add ticket modal is opened
            document.getElementById('addTicketModal').addEventListener('show.bs.modal', function() {
                loadEventsForTicketForm();
            });

            // Save ticket button click handler
            document.getElementById('saveTicketBtn').addEventListener('click', async function() {
                const form = document.getElementById('addTicketForm');
                const formData = new FormData(form);
                
                // Validate form data
                const eventId = formData.get('event_id');
                const type = formData.get('type');
                const price = formData.get('price');
                const quantity = formData.get('quantity');
                
                if (!eventId || !type || !price || !quantity) {
                    showError('Please fill in all required fields');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/tickets`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            event_id: eventId,
                            type: type,
                            price: parseFloat(price),
                            quantity: parseInt(quantity)
                        })
                    });
                    
                    if (response.ok) {
                        showSuccess('Ticket added successfully');
                        // Close modal using Bootstrap API
                        const addModal = bootstrap.Modal.getInstance(document.getElementById('addTicketModal'));
                        if (addModal) {
                            addModal.hide();
                        }
                        loadTickets();
                        loadDashboardData();
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to add ticket');
                    }
                } catch (error) {
                    console.error('Error adding ticket:', error);
                    showError(error.message || 'Failed to add ticket');
                }
            });

            // Update loadEventsForTicketForm to handle both add and edit forms
            async function loadEventsForTicketForm() {
                try {
                    const response = await fetch(`${API_BASE_URL}/events`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        // Update both add and edit form selects
                        const addEventSelect = document.querySelector('#addTicketForm select[name="event_id"]');
                        const editEventSelect = document.querySelector('#editTicketForm select[name="event_id"]');
                        
                        const options = data.data.map(event => 
                            `<option value="${event._id}">${event.name} (${new Date(event.date).toLocaleDateString()})</option>`
                        ).join('');
                        
                        if (addEventSelect) {
                            addEventSelect.innerHTML = '<option value="">Select an event</option>' + options;
                        }
                        if (editEventSelect) {
                            editEventSelect.innerHTML = '<option value="">Select an event</option>' + options;
                        }
                    }
                } catch (error) {
                    console.error('Error loading events for ticket form:', error);
                    showError('Failed to load events for ticket form');
                }
            }

            // Save user button click handler
            document.getElementById('saveUserBtn').addEventListener('click', async function() {
                const form = document.getElementById('addUserForm');
                const formData = new FormData(form);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(Object.fromEntries(formData))
                    });
                    
                    if (response.ok) {
                        showSuccess('User added successfully');
                        $('#addUserModal').modal('hide');
                        loadUsers();
                        loadDashboardData();
                    } else {
                        throw new Error('Failed to add user');
                    }
                } catch (error) {
                    console.error('Error adding user:', error);
                    showError('Failed to add user');
                }
            });

            // Save event button click handler
            document.getElementById('saveEventBtn').addEventListener('click', async function() {
                const form = document.getElementById('addEventForm');
                const formData = new FormData(form);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/events`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(Object.fromEntries(formData))
                    });
                    
                    if (response.ok) {
                        showSuccess('Event added successfully');
                        $('#addEventModal').modal('hide');
                        loadEvents();
                        loadDashboardData();
                    } else {
                        throw new Error('Failed to add event');
                    }
                } catch (error) {
                    console.error('Error adding event:', error);
                    showError('Failed to add event');
                }
            });

            // Check and refresh token if needed
            async function checkAndRefreshToken() {
                try {
                    console.log("Checking token validity...");
                    const response = await fetch(`${API_BASE_URL}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        console.error("Token is invalid or expired");
                        // Redirect to login page
                        window.location.href = '../login/login_signup/login.html';
                        return false;
                    }
                    
                    const data = await response.json();
                    console.log("User data:", data);
                    
                    if (data.success) {
                        // Update user info in the sidebar
                        const userNameElement = document.getElementById('userName');
                        const userRoleElement = document.getElementById('userRole');
                        const userAvatarElement = document.getElementById('userAvatar');

                        if (userNameElement) {
                            userNameElement.textContent = data.data.username;
                        }
                        if (userRoleElement) {
                            userRoleElement.textContent = data.data.role;
                        }
                        if (userAvatarElement && data.data.avatarUrl) {
                            userAvatarElement.src = data.data.avatarUrl;
                        }
                        return true;
                    } else {
                        console.error("Failed to get user data");
                        return false;
                    }
                } catch (error) {
                    console.error("Error checking token:", error);
                    return false;
                }
            }

            // Call this function when the page loads
            checkAndRefreshToken().then(isValid => {
                if (isValid) {
                    // Load dashboard data only if token is valid
                    loadDashboardData();
                }
            });

            // Add update ticket button click handler
            document.getElementById('updateTicketBtn').addEventListener('click', async function() {
                const form = document.getElementById('editTicketForm');
                const ticketId = document.getElementById('editTicketId').value;
                const formData = new FormData(form);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/tickets/${ticketId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            event_id: formData.get('event_id'),
                            type: formData.get('type'),
                            price: parseFloat(formData.get('price')),
                            quantity: parseInt(formData.get('quantity'))
                        })
                    });
                    
                    if (response.ok) {
                        showSuccess('Ticket updated successfully');
                        // Close modal using Bootstrap API
                        const editModal = bootstrap.Modal.getInstance(document.getElementById('editTicketModal'));
                        if (editModal) {
                            editModal.hide();
                        }
                        loadTickets();
                        loadDashboardData();
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to update ticket');
                    }
                } catch (error) {
                    console.error('Error updating ticket:', error);
                    showError(error.message || 'Failed to update ticket');
                }
            });

            // Update the addOrderEventListeners function
            function addOrderEventListeners() {
                // Edit order
                document.querySelectorAll('.edit-order').forEach(button => {
                    button.addEventListener('click', async function() {
                        const orderId = this.getAttribute('data-id');
                        try {
                            const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            if (data.success) {
                                const order = data.data;
                                // Populate the edit form
                                document.getElementById('editOrderId').value = order._id;
                                document.getElementById('editOrderStatus').value = order.status;
                                document.getElementById('editOrderPaymentMethod').value = order.payment_method;
                                
                                // Show the modal
                                const editModal = new bootstrap.Modal(document.getElementById('editOrderModal'));
                                editModal.show();
                            }
                        } catch (error) {
                            console.error('Error loading order:', error);
                            showError('Failed to load order details');
                        }
                    });
                });

                // Update order
                document.getElementById('updateOrderBtn').addEventListener('click', async function() {
                    const orderId = document.getElementById('editOrderId').value;
                    const status = document.getElementById('editOrderStatus').value;
                    const paymentMethod = document.getElementById('editOrderPaymentMethod').value;

                    try {
                        const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                status,
                                payment_method: paymentMethod
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to update order');
                        }

                        const data = await response.json();
                        if (data.success) {
                            showSuccess('Order updated successfully');
                            bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
                            loadOrders();
                            loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Error updating order:', error);
                        showError(error.message || 'Failed to update order');
                    }
                });

                // Delete order
                document.querySelectorAll('.delete-order').forEach(button => {
                    button.addEventListener('click', async function() {
                        const orderId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                            try {
                                const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                
                                if (response.ok) {
                                    showSuccess('Order deleted successfully');
                                    loadOrders();
                                    loadDashboardData();
                                } else {
                                    const errorData = await response.json();
                                    throw new Error(errorData.message || 'Failed to delete order');
                                }
                            } catch (error) {
                                console.error('Error deleting order:', error);
                                showError(error.message || 'Failed to delete order');
                            }
                        }
                    });
                });
            }

            // Functions for order management
            async function loadOrders() {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/orders`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Orders data:', data);
                    
                    const ordersTableBody = document.getElementById('ordersTableBody');
                    ordersTableBody.innerHTML = '';
                    
                    if (data.success && data.data && data.data.length > 0) {
                        data.data.forEach(order => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${order._id}</td>
                                <td>${order.user_id ? order.user_id.username : 'N/A'}</td>
                                <td>${order.event_id ? order.event_id.name : 'N/A'}</td>
                                <td>${order.ticket_id ? order.ticket_id._id : 'N/A'}</td>
                                <td>${order.total_price}</td>
                                <td>
                                    <span class="badge ${getOrderStatusBadgeClass(order.status)}">
                                        ${order.status}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-order" data-id="${order._id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-order" data-id="${order._id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            ordersTableBody.appendChild(row);
                        });
                    } else {
                        ordersTableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">No orders found</td>
                            </tr>
                        `;
                    }

                    // Add event listeners for order actions
                    addOrderEventListeners();
                } catch (error) {
                    console.error('Error loading orders:', error);
                    showError('Failed to load orders: ' + error.message);
                    const ordersTableBody = document.getElementById('ordersTableBody');
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">Error loading orders</td>
                        </tr>
                    `;
                } finally {
                    loading.style.display = 'none';
                }
            }

            // Helper function to get badge class based on order status
            function getOrderStatusBadgeClass(status) {
                switch(status?.toLowerCase()) {
                    case 'pending':
                        return 'bg-warning';
                    case 'paid':
                        return 'bg-success';
                    case 'cancelled':
                        return 'bg-danger';
                    default:
                        return 'bg-secondary';
                }
            }

            // Functions for ticket management
            async function loadTickets() {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';
                
                try {
                    console.log('Fetching tickets from API...');
                    const response = await fetch(`${API_BASE_URL}/tickets`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    console.log('Tickets API response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Tickets data:', data);
                    
                    const ticketsTableBody = document.getElementById('ticketsTableBody');
                    if (!ticketsTableBody) {
                        console.error('Tickets table body element not found!');
                        showError('Error: Tickets table element not found');
                        return;
                    }
                    
                    ticketsTableBody.innerHTML = '';
                    
                    if (data.success && data.data && data.data.length > 0) {
                        data.data.forEach(ticket => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${ticket._id}</td>
                                <td>${ticket.event_id ? ticket.event_id.name : 'N/A'}</td>
                                <td>${ticket.type}</td>
                                <td>${ticket.price}</td>
                                <td>${ticket.quantity}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary edit-ticket" data-id="${ticket._id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-ticket" data-id="${ticket._id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            ticketsTableBody.appendChild(row);
                        });
                    } else {
                        ticketsTableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">No tickets found</td>
                            </tr>
                        `;
                    }

                    // Add event listeners for ticket actions
                    addTicketEventListeners();
                } catch (error) {
                    console.error('Error loading tickets:', error);
                    showError('Failed to load tickets: ' + error.message);
                    const ticketsTableBody = document.getElementById('ticketsTableBody');
                    if (ticketsTableBody) {
                        ticketsTableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-danger">Error loading tickets: ${error.message}</td>
                            </tr>
                        `;
                    }
                } finally {
                    loading.style.display = 'none';
                }
            }

            document.getElementById('proceedToCheckout').addEventListener('click', function() {
                // Gather selected seat data
                const selectedSeats = Array.from(document.querySelectorAll('.seat.selected')).map(seat => seat.dataset.seatId);
                
                if (selectedSeats.length === 0) {
                    alert('Vui lòng chọn ít nhất một ghế để tiếp tục.');
                    return;
                }
                
                // Redirect to booking page with seat data
                window.location.href = `/booking?seats=${selectedSeats.join(',')}`;
            });
        });
    </script>
</body>
</html> 