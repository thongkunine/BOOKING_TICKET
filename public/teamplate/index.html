<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Events - Trang chủ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #343a40;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .navbar-brand {
            font-weight: bold;
            color: #fff !important;
        }
        .nav-link {
            color: rgba(255,255,255,.8) !important;
        }
        .nav-link:hover {
            color: #fff !important;
        }
        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1626224583764-f87db24ac4ea?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
            margin-bottom: 40px;
        }
        .hero-section h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .hero-section p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        .event-card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            transition: transform 0.3s;
        }
        .event-card:hover {
            transform: translateY(-5px);
        }
        .event-card img {
            height: 200px;
            object-fit: cover;
        }
        .event-card .card-body {
            padding: 20px;
        }
        .event-card .card-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .event-card .card-text {
            color: #6c757d;
            margin-bottom: 15px;
        }
        .event-card .badge {
            margin-right: 5px;
        }
        .btn-primary {
            background-color: #4a90e2;
            border: none;
        }
        .btn-primary:hover {
            background-color: #357abd;
        }
        .footer {
            background-color: #343a40;
            color: white;
            padding: 40px 0;
            margin-top: 50px;
        }
        .footer h5 {
            font-weight: bold;
            margin-bottom: 20px;
        }
        .footer ul {
            list-style: none;
            padding: 0;
        }
        .footer ul li {
            margin-bottom: 10px;
        }
        .footer ul li a {
            color: rgba(255,255,255,.8);
            text-decoration: none;
        }
        .footer ul li a:hover {
            color: white;
        }
        .social-icons a {
            color: white;
            margin-right: 15px;
            font-size: 20px;
        }
        .social-icons a:hover {
            color: #4a90e2;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .loading i {
            font-size: 24px;
            color: #4a90e2;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            display: none;
            margin-top: 20px;
            border-radius: 8px;
        }
        .event-details {
            display: none;
        }
        .event-details.active {
            display: block;
        }
        .seat-selection {
            background-color: #f8f9fa;
            padding: 3rem 0;
        }
        .seat-map {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .seat-legend {
            margin-bottom: 2.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .seat-legend-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .seat {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
        }
        .seat.available {
            background-color: #e9ecef;
            border: 2px solid #dee2e6;
        }
        .seat.available:hover {
            background-color: #dee2e6;
            transform: scale(1.1);
        }
        .seat.selected {
            background-color: #4a90e2;
            border: 2px solid #357abd;
            color: white;
        }
        .seat.reserved {
            background-color: #ffc107;
            border: 2px solid #d39e00;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .seat.sold {
            background-color: #dc3545;
            border: 2px solid #bd2130;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .seat-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 12px;
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .booking-summary {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 2rem;
        }
        .selected-seats-list {
            max-height: 250px;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .selected-seat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .selected-seat-item:last-child {
            margin-bottom: 0;
        }
        .booking-actions {
            margin-top: 2rem;
        }
        .booking-actions button {
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .booking-actions button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .booking-actions button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Badminton Events</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Sự kiện</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Về chúng tôi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Liên hệ</a>
                    </li>
                    <li class="nav-item" id="loginNavItem">
                        <a class="nav-link" href="login/login_signup/login.html">Đăng nhập</a>
                    </li>
                    <li class="nav-item" id="signupNavItem">
                        <a class="nav-link" href="login/login_signup/signup.html">Đăng ký</a>
                    </li>
                    <li class="nav-item dropdown" id="userNavItem" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span id="userDisplayName">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="login/login_signup/profile.html" id="profileLink">Hồ sơ</a></li>
                            <li><a class="dropdown-item" href="" id="ordersLink">Đơn hàng</a></li>
                            <li id="adminLinkContainer" style="display: none;"><a class="dropdown-item" href="admin/admin.html" id="adminLink">Admin</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutLink">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <h1>Khám phá các sự kiện cầu lông</h1>
            <p>Đặt vé và tham gia các giải đấu cầu lông hấp dẫn</p>
            <a href="#events" class="btn btn-primary btn-lg">Xem sự kiện</a>
        </div>
    </section>

    <!-- Events Section -->
    <section id="events" class="py-5">
        <div class="container">
            <h2 class="text-center mb-5">Sự kiện sắp diễn ra</h2>
            
            <!-- Alert messages -->
            <div class="alert alert-success" id="successAlert" role="alert"></div>
            <div class="alert alert-danger" id="errorAlert" role="alert"></div>
            
            <!-- Loading indicator -->
            <div class="loading" id="loading">
                <i class="fas fa-spinner"></i> Đang tải...
            </div>
            
            <!-- Events List -->
            <div class="row" id="eventsList">
                <!-- Events will be loaded here -->
            </div>
            
            <!-- Event Details -->
            <div class="event-details" id="eventDetails">
                <div class="row">
                    <div class="col-md-8">
                        <h3 id="eventName">Tên sự kiện</h3>
                        <p id="eventDate">Ngày: </p>
                        <p id="eventLocation">Địa điểm: </p>
                        
                        <!-- Seat Selection Section -->
                        <section class="seat-selection">
                            <div class="container">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <div class="seat-map">
                                            <h3 class="mb-4">Chọn ghế của bạn</h3>
                                            <div class="seat-legend">
                                                <div class="d-flex flex-wrap gap-3">
                                                    <div class="seat-legend-item">
                                                        <div class="seat available"></div>
                                                        <span>Còn trống</span>
                                                    </div>
                                                    <div class="seat-legend-item">
                                                        <div class="seat selected"></div>
                                                        <span>Đã chọn</span>
                                                    </div>
                                                    <div class="seat-legend-item">
                                                        <div class="seat reserved"></div>
                                                        <span>Đã đặt trước</span>
                                                    </div>
                                                    <div class="seat-legend-item">
                                                        <div class="seat sold"></div>
                                                        <span>Đã bán</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="seatMap" class="seat-grid">
                                                <!-- Seats will be dynamically added here -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="booking-summary">
                                            <h3 class="mb-4">Tổng quan đặt vé</h3>
                                            <div class="selected-seats mb-4">
                                                <h5>Ghế đã chọn</h5>
                                                <div id="selectedSeatsList" class="selected-seats-list">
                                                    <!-- Selected seats will be listed here -->
                                                </div>
                                            </div>
                                            <div class="booking-actions">
                                                <button id="proceedToBooking" class="btn btn-primary w-100" disabled>
                                                    Tiếp tục đặt vé
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Thông tin đặt vé</h5>
                                <div id="loginMessage">
                                    
                                    <p class="card-text">Vui lòng đăng nhập để đặt vé.</p>
                                    <a href="login/login_signup/login.html" class="btn btn-primary">Đăng nhập</a>
                                </div>
                                <div id="bookingInfo" style="display: none">
                                    <p class="card-text">Bạn có thể đặt vé ngay bây giờ.</p>
                                    <p class="card-text">Vui lòng chọn ghế và số lượng vé mong muốn.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Seat Modal -->
            <div class="modal fade" id="addSeatModal" tabindex="-1" aria-labelledby="addSeatModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addSeatModalLabel">Thêm ghế mới</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addSeatForm">
                                <div class="mb-3">
                                    <label for="eventSelect" class="form-label">Sự kiện</label>
                                    <select class="form-select" id="eventSelect" required>
                                        <option value="">Chọn sự kiện</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="seatNumber" class="form-label">Số ghế</label>
                                    <input type="text" class="form-control" id="seatNumber" required>
                                </div>
                                <div class="mb-3">
                                    <label for="seatType" class="form-label">Loại ghế</label>
                                    <select class="form-select" id="seatType" required>
                                        <option value="VIP">VIP</option>
                                        <option value="Thường">Thường</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="seatStatus" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="seatStatus" required>
                                        <option value="available">Còn trống</option>
                                        <option value="reserved">Đã đặt trước</option>
                                        <option value="sold">Đã bán</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-primary" id="saveSeatBtn">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Badminton Events</h5>
                    <p>Nền tảng đặt vé cho các sự kiện cầu lông hàng đầu Việt Nam.</p>
                    <div class="social-icons">
                        <a href="https://www.facebook.com/ThongKunine"><i class="fab fa-facebook"></i></a>
                        <a href="https://www.facebook.com/ThongKunine"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.instagram.com/mithon.dmt/"><i class="fab fa-instagram"></i></a>
                        <a href="https://www.facebook.com/ThongKunine"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>Liên kết nhanh</h5>
                    <ul>
                        <li><a href="index.html">Trang chủ</a></li>
                        <li><a href="user/event.html">Sự kiện</a></li>
                        <li><a href="#">Về chúng tôi</a></li>
                        <li><a href="#">Liên hệ</a></li>
                        <li><a href="#">Điều khoản sử dụng</a></li>
                        <li><a href="#">Chính sách bảo mật</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Liên hệ</h5>
                    <ul>
                        <li><i class="fas fa-map-marker-alt"></i> 123 Đường ABC, Quận XYZ, Hà Nội</li>
                        <li><i class="fas fa-phone"></i> +84 123 456 789</li>
                        <li><i class="fas fa-envelope"></i> info@badmintonevents.com</li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p>&copy; 2023 Badminton Events. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const eventsList = document.getElementById('eventsList');
            const eventDetails = document.getElementById('eventDetails');
            const loading = document.getElementById('loading');
            const successAlert = document.getElementById('successAlert');
            const errorAlert = document.getElementById('errorAlert');
            const seatSelection = document.getElementById('seatSelection');
            const selectedSeatsDisplay = document.getElementById('selectedSeatsList');
            const totalPriceDisplay = document.getElementById('totalPrice');
            const bookButton = document.getElementById('proceedToCheckout');
            const backButton = document.getElementById('backButton');
            
            // Kiểm tra trạng thái đăng nhập
            const token = localStorage.getItem('token');
            const loginNavItem = document.getElementById('loginNavItem');
            const signupNavItem = document.getElementById('signupNavItem');
            const userNavItem = document.getElementById('userNavItem');
            const userDisplayName = document.getElementById('userDisplayName');

            if (token) {
                // Nếu đã đăng nhập
                loginNavItem.style.display = 'none';
                signupNavItem.style.display = 'none';
                userNavItem.style.display = 'block';
                
                // Hiển thị thông tin đặt vé cho người dùng đã đăng nhập
                document.getElementById('loginMessage').style.display = 'none';
                document.getElementById('bookingInfo').style.display = 'block';

                // Lấy thông tin người dùng
                fetch('http://localhost:4000/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        userDisplayName.textContent = data.data.username;
                        
                        // Kiểm tra vai trò người dùng
                        const userRole = data.data.role?.name || data.data.role;
                        console.log('User role:', userRole);
                        
                        // Hiển thị nút Admin nếu người dùng là admin
                        if (userRole === 'admin' || userRole === 'Admin' || userRole === 'Administrator') {
                            document.getElementById('adminLinkContainer').style.display = 'block';
                        } else {
                            document.getElementById('adminLinkContainer').style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    localStorage.removeItem('token');
                    window.location.reload();
                });

                // Xử lý đăng xuất
                document.getElementById('logoutLink').addEventListener('click', function(e) {
                    e.preventDefault();
                    localStorage.removeItem('token');
                    window.location.reload();
                });
            } else {
                // Nếu chưa đăng nhập
                loginNavItem.style.display = 'block';
                signupNavItem.style.display = 'block';
                userNavItem.style.display = 'none';
                
                // Hiển thị thông tin đặt vé cho người dùng chưa đăng nhập
                document.getElementById('loginMessage').style.display = 'block';
                document.getElementById('bookingInfo').style.display = 'none';
            }
            
            // Hiển thị loading
            loading.style.display = 'block';
            
            // Lấy danh sách sự kiện từ API
            fetch('http://localhost:4000/events')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không thể tải danh sách sự kiện. Vui lòng thử lại sau.');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        displayEvents(data.data);
                    } else {
                        throw new Error(data.message || 'Không thể tải danh sách sự kiện.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    errorAlert.textContent = error.message || 'Đã xảy ra lỗi khi tải danh sách sự kiện.';
                    errorAlert.style.display = 'block';
                    loading.style.display = 'none';
                });
            
            // Hiển thị danh sách sự kiện
            function displayEvents(events) {
                eventsList.innerHTML = '';
                
                if (events.length === 0) {
                    eventsList.innerHTML = '<div class="col-12 text-center"><p>Không có sự kiện nào sắp diễn ra.</p></div>';
                    loading.style.display = 'none';
                    return;
                }
                
                events.forEach(event => {
                    const eventCard = document.createElement('div');
                    eventCard.className = 'col-md-4';
                    eventCard.innerHTML = `
                        <div class="card event-card">
                            <img src="${event.image || 'https://images.unsplash.com/photo-1626224583764-f87db24ac4ea?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'}" class="card-img-top" alt="${event.name}">
                            <div class="card-body">
                                <h5 class="card-title">${event.name}</h5>
                                <p class="card-text">
                                    <i class="fas fa-calendar-alt"></i> ${new Date(event.date).toLocaleDateString()}<br>
                                    <i class="fas fa-map-marker-alt"></i> ${event.location}
                                </p>
                                <p class="card-text">${event.description ? event.description.substring(0, 100) + '...' : 'Không có mô tả'}</p>
                                <button class="btn btn-primary view-event" data-id="${event._id}">Xem chi tiết</button>
                            </div>
                        </div>
                    `;
                    eventsList.appendChild(eventCard);
                });
                
                // Thêm sự kiện cho nút xem chi tiết
                document.querySelectorAll('.view-event').forEach(button => {
                    button.addEventListener('click', function() {
                        const eventId = this.getAttribute('data-id');
                        loadEventDetails(eventId);
                    });
                });
                
                // Ẩn loading
                loading.style.display = 'none';
            }
            
            // Lấy chi tiết sự kiện từ API
            function loadEventDetails(eventId) {
                // Save current event ID
                currentEventId = eventId;
                
                // Show loading
                if (loading) loading.style.display = 'block';
                
                // Hide alerts
                if (successAlert) successAlert.style.display = 'none';
                if (errorAlert) errorAlert.style.display = 'none';
                
                // Get event details
                fetch(`http://localhost:4000/events/${eventId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Không thể tải thông tin sự kiện');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const event = data.data;
                            
                            // Update event information with null checks
                            const eventNameElement = document.getElementById('eventName');
                            const eventDateElement = document.getElementById('eventDate');
                            const eventLocationElement = document.getElementById('eventLocation');
                            const eventDescriptionElement = document.getElementById('eventDescription');
                            
                            if (eventNameElement) eventNameElement.textContent = event.name;
                            if (eventDateElement) eventDateElement.textContent = `Ngày: ${new Date(event.date).toLocaleDateString()}`;
                            if (eventLocationElement) eventLocationElement.textContent = `Địa điểm: ${event.location}`;
                            if (eventDescriptionElement) eventDescriptionElement.textContent = `Mô tả: ${event.description || 'Không có mô tả'}`;
                            
                            // Show event details section
                            const eventsList = document.getElementById('eventsList');
                            const eventDetails = document.getElementById('eventDetails');
                            
                            if (eventsList) eventsList.style.display = 'none';
                            if (eventDetails) {
                                eventDetails.style.display = 'block';
                                // Scroll to event details
                                eventDetails.scrollIntoView({ behavior: 'smooth' });
                            }
                            
                            // Get seats for the event
                            return fetch(`http://localhost:4000/seats/event/${eventId}`);
                        } else {
                            throw new Error(data.message || 'Không thể tải thông tin sự kiện');
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Không thể tải danh sách ghế');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Display seats
                            displaySeats(data.data);
                        } else {
                            // If no seats found, display a message
                            const seatsContainer = document.getElementById('seatsContainer');
                            if (seatsContainer) {
                                seatsContainer.innerHTML = '<div class="alert alert-info">Chưa có ghế nào được tạo cho sự kiện này.</div>';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading event details:', error);
                        
                        // Hide loading
                        if (loading) loading.style.display = 'none';
                        
                        // Show error message
                        if (errorAlert) {
                            errorAlert.textContent = error.message || 'Đã xảy ra lỗi khi tải thông tin sự kiện. Vui lòng thử lại sau.';
                            errorAlert.style.display = 'block';
                        }
                    });
            }
            
            // Hiển thị danh sách ghế
            function displaySeats(seats) {
                const seatMap = document.getElementById('seatMap');
                if (!seatMap) {
                    console.error('Seat map container not found');
                    return;
                }
                
                seatMap.innerHTML = '';
                
                if (!seats || seats.length === 0) {
                    seatMap.innerHTML = '<div class="col-12 text-center"><p>Chưa có ghế nào được tạo cho sự kiện này.</p></div>';
                    return;
                }
                
                // Tạo container cho từng loại ghế
                const seatTypes = {};
                seats.forEach(seat => {
                    // Kiểm tra xem seat có thuộc tính type không, nếu không thì gán giá trị mặc định
                    const seatType = seat.type || 'Thường';
                    if (!seatTypes[seatType]) {
                        seatTypes[seatType] = [];
                    }
                    seatTypes[seatType].push(seat);
                });
                
                // Hiển thị ghế theo từng loại
                Object.entries(seatTypes).forEach(([type, typeSeats]) => {
                    // Tạo tiêu đề cho loại ghế
                    const typeHeader = document.createElement('div');
                    typeHeader.className = 'col-12 mt-3';
                    
                    // Kiểm tra xem ghế đầu tiên có thuộc tính price không
                    const price = typeSeats[0].price ? typeSeats[0].price.toLocaleString() : '';
                    typeHeader.innerHTML = `<h5>${type} ${price ? '- ' + price + ' VNĐ' : ''}</h5>`;
                    seatMap.appendChild(typeHeader);
                    
                    // Tạo container cho ghế
                    const seatsContainer = document.createElement('div');
                    seatsContainer.className = 'col-12 d-flex flex-wrap gap-2';
                    
                    // Thêm từng ghế vào container
                    typeSeats.forEach(seat => {
                        const seatElement = document.createElement('div');
                        seatElement.className = `seat ${seat.status === 'available' ? 'available' : 'unavailable'}`;
                        seatElement.textContent = seat.seat_number;
                        seatElement.dataset.seatId = seat._id;
                        
                        // Kiểm tra xem ghế có thuộc tính price không
                        const seatPrice = seat.price ? seat.price.toLocaleString() : '0';
                        seatElement.title = `${seat.seat_number} - ${type} - ${seatPrice} VNĐ`;
                        
                        if (seat.status === 'available') {
                            seatElement.addEventListener('click', function() {
                                toggleSeatSelection(seat);
                            });
                        }
                        
                        seatsContainer.appendChild(seatElement);
                    });
                    
                    seatMap.appendChild(seatsContainer);
                });
                
                // Tạo chú thích cho các loại ghế
                const legend = document.createElement('div');
                legend.className = 'col-12 mt-3';
                legend.innerHTML = `
                    <div class="seat-legend">
                        <span class="badge bg-success me-2">Ghế trống</span>
                        <span class="badge bg-primary me-2">Ghế đã chọn</span>
                        <span class="badge bg-danger me-2">Ghế đã đặt</span>
                    </div>
                `;
                
                seatMap.appendChild(legend);
            }
            
            // Biến lưu trữ ghế đã chọn
            let selectedSeats = new Set();
            
            // Chọn/bỏ chọn ghế
            function toggleSeatSelection(seat) {
                // Tìm phần tử ghế trong DOM bằng cách tìm trong tất cả các container ghế
                let seatElement = null;
                const seatContainers = document.querySelectorAll('.col-12.d-flex.flex-wrap.gap-2');
                
                for (const container of seatContainers) {
                    const foundSeat = Array.from(container.children).find(el => 
                        el.textContent === seat.seat_number && 
                        el.classList.contains('seat')
                    );
                    
                    if (foundSeat) {
                        seatElement = foundSeat;
                        break;
                    }
                }
                
                if (!seatElement) {
                    console.error('Không tìm thấy phần tử ghế trong DOM:', seat);
                    return;
                }
                
                if (selectedSeats.has(seat._id)) {
                    // Bỏ chọn ghế
                    selectedSeats.delete(seat._id);
                    seatElement.classList.remove('selected');
                } else {
                    // Chọn ghế
                    selectedSeats.add(seat._id);
                    seatElement.classList.add('selected');
                }
                
                // Cập nhật hiển thị ghế đã chọn và tổng tiền
                updateSelectedSeatsList();
            }
            
            // Cập nhật hiển thị ghế đã chọn và tổng tiền
            function updateSelectedSeatsList() {
                const selectedSeatsList = document.getElementById('selectedSeatsList');
                if (!selectedSeatsList) {
                    console.error('Selected seats list container not found');
                    return;
                }
                
                selectedSeatsList.innerHTML = '';
                
                selectedSeats.forEach(seatId => {
                    const seatElement = document.querySelector(`[data-seat-id="${seatId}"]`);
                    if (!seatElement) {
                        console.error(`Seat element with ID ${seatId} not found`);
                        return;
                    }
                    
                    const seatNumber = seatElement.textContent;
                    
                    const seatItem = document.createElement('div');
                    seatItem.className = 'selected-seat-item';
                    seatItem.innerHTML = `
                        <span>Seat ${seatNumber}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeSeat('${seatId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    selectedSeatsList.appendChild(seatItem);
                });
                
                // Cập nhật trạng thái nút đặt vé
                const proceedButton = document.getElementById('proceedToBooking');
                if (proceedButton) {
                    proceedButton.disabled = selectedSeats.size === 0;
                }
            }
            
            // Xử lý nút đặt vé
            const proceedButton = document.getElementById('proceedToBooking');
            if (proceedButton) {
                proceedButton.addEventListener('click', function() {
                    if (!token) {
                        // Nếu chưa đăng nhập, chuyển đến trang đăng nhập
                        window.location.href = 'login/login_signup/login.html';
                        return;
                    }
                    
                    if (selectedSeats.size === 0) {
                        // Hiển thị thông báo lỗi nếu chưa chọn ghế
                        errorAlert.textContent = 'Vui lòng chọn ít nhất một ghế để đặt vé.';
                        errorAlert.style.display = 'block';
                        return;
                    }
                    
                    // Hiển thị loading
                    loading.style.display = 'block';
                    
                    // Tạo dữ liệu đơn hàng
                    const orderData = {
                        event_id: currentEventId,
                        seats: Array.from(selectedSeats),
                        total_price: 0, // Tổng giá tiền sẽ được tính ở server
                        status: 'pending',
                        payment_method: 'cash'
                    };
                    
                    // Gửi yêu cầu đặt vé đến API
                    fetch('http://localhost:4000/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(orderData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Không thể đặt vé. Vui lòng thử lại sau.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Ẩn loading
                        loading.style.display = 'none';
                        
                        // Hiển thị thông báo thành công
                        successAlert.textContent = 'Đặt vé thành công! Vui lòng kiểm tra email để xem chi tiết vé.';
                        successAlert.style.display = 'block';
                        
                        // Reset ghế đã chọn
                        selectedSeats.clear();
                        updateSelectedSeatsList();
                        
                        // Quay lại danh sách sự kiện sau 2 giây
                        setTimeout(() => {
                            backToList();
                        }, 2000);
                    })
                    .catch(error => {
                        // Ẩn loading
                        loading.style.display = 'none';
                        
                        // Hiển thị thông báo lỗi
                        errorAlert.textContent = error.message || 'Đã xảy ra lỗi khi đặt vé. Vui lòng thử lại sau.';
                        errorAlert.style.display = 'block';
                    });
                });
            }
            
            // Xử lý nút quay lại
            if (backButton) {
                backButton.addEventListener('click', function() {
                    backToList();
                });
            }
            
            // Quay lại danh sách sự kiện
            function backToList() {
                eventsList.style.display = 'flex';
                eventDetails.style.display = 'none';
                successAlert.style.display = 'none';
                errorAlert.style.display = 'none';
                
                // Cuộn đến danh sách sự kiện
                eventsList.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Function to load events for the seat form
        async function loadEventsForSeatForm() {
            try {
                const response = await fetch('http://localhost:4000/events');
                const events = await response.json();
                const eventSelect = document.getElementById('eventSelect');
                eventSelect.innerHTML = '<option value="">Chọn sự kiện</option>';
                
                events.forEach(event => {
                    const option = document.createElement('option');
                    option.value = event._id;
                    option.textContent = `${event.name} - ${new Date(event.date).toLocaleDateString()}`;
                    eventSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading events:', error);
                showAlert('error', 'Không thể tải danh sách sự kiện');
            }
        }

        // Function to save a new seat
        async function saveSeat() {
            const formData = {
                event_id: document.getElementById('eventSelect').value,
                seat_number: document.getElementById('seatNumber').value,
                type: document.getElementById('seatType').value,
                status: document.getElementById('seatStatus').value
            };

            // Validate form data
            if (!formData.event_id || !formData.seat_number || !formData.type || !formData.status) {
                showAlert('error', 'Vui lòng điền đầy đủ thông tin');
                return;
            }

            try {
                const response = await fetch('http://localhost:4000/seats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showAlert('success', 'Thêm ghế thành công');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addSeatModal'));
                    modal.hide();
                    document.getElementById('addSeatForm').reset();
                    // Reload seats if we're on the event details page
                    if (currentEventId) {
                        loadEventDetails(currentEventId);
                    }
                } else {
                    const error = await response.json();
                    showAlert('error', error.message || 'Không thể thêm ghế');
                }
            } catch (error) {
                console.error('Error saving seat:', error);
                showAlert('error', 'Không thể thêm ghế');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Check if the modal exists
            const addSeatModal = document.getElementById('addSeatModal');
            if (addSeatModal) {
                // Add event listener for modal show event
                addSeatModal.addEventListener('show.bs.modal', function() {
                    loadEventsForSeatForm();
                });
            }
            
            // Check if the save button exists
            const saveSeatBtn = document.getElementById('saveSeatBtn');
            if (saveSeatBtn) {
                saveSeatBtn.addEventListener('click', saveSeat);
            }
        });
    </script>
</body>
</html> 